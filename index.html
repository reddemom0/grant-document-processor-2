<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grant Document Processor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            max-width: 300px;
            height: auto;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin: 10px 0;
            font-size: 24px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background-color: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #4A90C2;
            background-color: #f0f8ff;
        }
        
        input[type="file"] {
            margin: 10px 0;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            margin: 10px 0;
        }
        
        button {
            background: #4A90C2;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #357ABD;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .status.info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
        }
        
        .status.success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        
        .status.error {
            background: #ffeaea;
            border: 1px solid #f44336;
            color: #c62828;
        }
        
        .results {
            margin-top: 30px;
            display: none;
        }
        
        .chunk {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        
        .chunk-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chunk-content {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .copy-btn {
            padding: 5px 10px;
            font-size: 12px;
            background: #28a745;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .summary {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .summary h3 {
            margin-top: 0;
            color: #856404;
        }
        
        .manual-input {
            background: #e8f4fd;
            border: 1px solid #4A90C2;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .manual-input h3 {
            margin-top: 0;
            color: #2c5aa0;
        }
    </style>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg class="logo" viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
                <text x="50" y="40" font-family="Arial, sans-serif" font-size="32" font-weight="300" fill="#888">
                    GR
                </text>
                <text x="110" y="40" font-family="Arial, sans-serif" font-size="32" font-weight="300" fill="#4A90C2">
                    A
                </text>
                <text x="140" y="40" font-family="Arial, sans-serif" font-size="32" font-weight="300" fill="#888">
                    NTED
                </text>
                
                <text x="200" y="50" font-family="Arial, sans-serif" font-size="14" font-weight="300" fill="#888" letter-spacing="3">
                    CONSULTING
                </text>
                
                <path d="M 50 50 Q 70 45 90 50 Q 70 55 50 50" stroke="#4A90C2" stroke-width="2" fill="none"/>
                <path d="M 55 55 Q 75 50 95 55 Q 75 60 55 55" stroke="#4A90C2" stroke-width="1.5" fill="none" opacity="0.7"/>
                <path d="M 60 60 Q 80 55 100 60 Q 80 65 60 60" stroke="#4A90C2" stroke-width="1" fill="none" opacity="0.5"/>
            </svg>
            
            <h1>Grant Document Processor</h1>
            <p class="subtitle">Extract and prepare grant documents for CustomGPT.ai analysis</p>
        </div>
        
        <div class="upload-area">
            <h3>Upload Grant Document</h3>
            <p>Select a PDF file to extract and process text for CustomGPT.ai</p>
            <input type="file" id="fileInput" accept=".pdf" />
            <br>
            <button onclick="processDocument()" id="processBtn">Process PDF</button>
        </div>
        
        <div class="manual-input">
            <h3>Or Paste Text Directly</h3>
            <p>If you already have the text from your grant document, paste it below:</p>
            <textarea id="manualText" placeholder="Paste your grant document text here..."></textarea>
            <button onclick="processManualText()" id="manualBtn">Process Text</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="results" class="results">
            <div id="summary" class="summary" style="display: none;">
                <h3>Processing Summary</h3>
                <p id="summaryText"></p>
            </div>
            
            <div id="chunks"></div>
        </div>
    </div>

    <script>
        const MAX_CHUNK_SIZE = 15000; // Increased to reduce number of chunks
        
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        async function processDocument() {
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');
            
            if (!fileInput.files[0]) {
                showStatus('Please select a PDF file first', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!file.type.includes('pdf')) {
                showStatus('Please select a PDF file', 'error');
                return;
            }
            
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';
            showStatus('Extracting text from PDF...', 'info');
            
            try {
                const extractedText = await extractTextFromPDF(file);
                showStatus('Text extracted successfully! Analyzing and chunking...', 'info');
                await processExtractedText(extractedText);
                showStatus('Document processed successfully!', 'success');
            } catch (error) {
                console.error('Error processing document:', error);
                showStatus('Error: ' + error.message, 'error');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Process PDF';
            }
        }
        
        async function processManualText() {
            const textArea = document.getElementById('manualText');
            const manualBtn = document.getElementById('manualBtn');
            
            const text = textArea.value.trim();
            
            if (!text) {
                showStatus('Please paste some text first', 'error');
                return;
            }
            
            manualBtn.disabled = true;
            manualBtn.textContent = 'Processing...';
            showStatus('Analyzing and chunking text...', 'info');
            
            try {
                await processExtractedText(text);
                showStatus('Text processed successfully!', 'success');
            } catch (error) {
                console.error('Error processing text:', error);
                showStatus('Error: ' + error.message, 'error');
            } finally {
                manualBtn.disabled = false;
                manualBtn.textContent = 'Process Text';
            }
        }
        
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            let fullText = '';
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            
            if (!fullText || fullText.trim().length === 0) {
                throw new Error('No text could be extracted from the PDF. The PDF might be image-based or protected.');
            }
            
            return fullText.trim();
        }
        
        async function processExtractedText(text) {
            const charCount = text.length;
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            const summaryText = document.getElementById('summaryText');
            const chunksDiv = document.getElementById('chunks');
            
            chunksDiv.innerHTML = '';
            resultsDiv.style.display = 'block';
            summaryDiv.style.display = 'block';
            
            if (charCount <= MAX_CHUNK_SIZE) {
                summaryText.innerHTML = '<strong>Document Length:</strong> ' + charCount.toLocaleString() + ' characters<br>' +
                    '<strong>Processing Method:</strong> Single message (fits within CustomGPT.ai limit)<br>' +
                    '<strong>Ready for:</strong> Direct copy/paste to CustomGPT.ai';
                
                createChunkElement(text, 1, 1, 'Complete Document');
            } else {
                const chunks = smartChunkText(text);
                
                summaryText.innerHTML = '<strong>Document Length:</strong> ' + charCount.toLocaleString() + ' characters<br>' +
                    '<strong>Processing Method:</strong> Split into ' + chunks.length + ' chunks<br>' +
                    '<strong>Instructions:</strong> Copy and paste each chunk sequentially to CustomGPT.ai';
                
                chunks.forEach(function(chunk, index) {
                    createChunkElement(chunk, index + 1, chunks.length, 'Chunk ' + (index + 1));
                });
            }
        }
        
        function smartChunkText(text) {
            const chunks = [];
            let remainingText = text;
            
            // First, try to split by major sections to keep related content together
            const sectionSplits = splitByMajorSections(text);
            
            if (sectionSplits.length > 1 && sectionSplits.every(section => section.length <= MAX_CHUNK_SIZE)) {
                return sectionSplits;
            }
            
            // If section-based splitting doesn't work, use character-based chunking
            while (remainingText.length > 0) {
                if (remainingText.length <= MAX_CHUNK_SIZE) {
                    chunks.push(remainingText.trim());
                    break;
                }
                
                const splitPoint = findBestSplitPoint(remainingText, MAX_CHUNK_SIZE);
                const chunk = remainingText.substring(0, splitPoint).trim();
                
                if (chunk) {
                    chunks.push(chunk);
                }
                
                remainingText = remainingText.substring(splitPoint).trim();
            }
            
            return chunks;
        }
        
        function splitByMajorSections(text) {
            // Common grant document section patterns
            const sectionPatterns = [
                /(?:^|\n\n)\s*(?:OVERVIEW|DESCRIPTION|PURPOSE|ABOUT|INTRODUCTION)/i,
                /(?:^|\n\n)\s*(?:ELIGIBILITY|ELIGIBLE|CRITERIA|REQUIREMENTS|WHO CAN APPLY)/i,
                /(?:^|\n\n)\s*(?:FUNDING|GRANT VALUE|AMOUNT|FINANCIAL|BUDGET)/i,
                /(?:^|\n\n)\s*(?:EXPENSES|COSTS|ELIGIBLE COSTS|ALLOWABLE|EXPENDITURES)/i,
                /(?:^|\n\n)\s*(?:APPLICATION|APPLY|PROCESS|PROCEDURE|HOW TO APPLY)/i,
                /(?:^|\n\n)\s*(?:PROGRAM DETAILS|DETAILS|TERMS|CONDITIONS|ADDITIONAL)/i
            ];
            
            const sections = [];
            let currentPos = 0;
            
            for (let i = 0; i < sectionPatterns.length; i++) {
                const match = text.substring(currentPos).search(sectionPatterns[i]);
                if (match !== -1) {
                    const actualPos = currentPos + match;
                    if (currentPos < actualPos) {
                        const section = text.substring(currentPos, actualPos).trim();
                        if (section && section.length > 100) {
                            sections.push(section);
                        }
                    }
                    currentPos = actualPos;
                }
            }
            
            // Add the remaining text
            if (currentPos < text.length) {
                const lastSection = text.substring(currentPos).trim();
                if (lastSection && lastSection.length > 100) {
                    sections.push(lastSection);
                }
            }
            
            // If no sections found, return empty array to fall back to character-based chunking
            return sections.length > 1 ? sections : [];
        }
        
        function findBestSplitPoint(text, maxLength) {
            if (text.length <= maxLength) {
                return text.length;
            }
            
            const searchStart = Math.max(0, maxLength - 300);
            
            const breakPoints = [
                text.lastIndexOf('\n\n', maxLength),    // Paragraph break
                text.lastIndexOf('. ', maxLength),       // Sentence end
                text.lastIndexOf('\n', maxLength),       // Line break
                text.lastIndexOf(' ', maxLength)         // Word boundary
            ];
            
            for (let i = 0; i < breakPoints.length; i++) {
                if (breakPoints[i] > searchStart) {
                    return breakPoints[i] + 1;
                }
            }
            
            return maxLength;
        }
        
        function createChunkElement(content, chunkNumber, totalChunks, title) {
            const chunksDiv = document.getElementById('chunks');
            
            const chunkDiv = document.createElement('div');
            chunkDiv.className = 'chunk';
            
            let promptText;
            if (totalChunks === 1) {
                promptText = 'Process this grant document and create a formatted grant card:\n\n' + content;
            } else if (chunkNumber === 1) {
                promptText = 'I will provide you with a grant document in ' + totalChunks + ' chunks. Please read and remember ALL information from each chunk. Do NOT generate the grant card until I send the final chunk.\n\n' +
                'CHUNK ' + chunkNumber + ' OF ' + totalChunks + ':\n' +
                '='.repeat(50) + '\n' +
                content + '\n' +
                '='.repeat(50) + '\n\n' +
                'Please confirm you have received and stored chunk ' + chunkNumber + ' of ' + totalChunks + '. I will send the next chunk shortly.';
            } else if (chunkNumber === totalChunks) {
                promptText = 'FINAL CHUNK ' + chunkNumber + ' OF ' + totalChunks + ':\n' +
                '='.repeat(50) + '\n' +
                content + '\n' +
                '='.repeat(50) + '\n\n' +
                'Now that you have received ALL ' + totalChunks + ' chunks, please:\n\n' +
                '1. Review ALL the information from chunks 1-' + totalChunks + '\n' +
                '2. Generate a COMPREHENSIVE grant card that includes information from ALL chunks\n' +
                '3. Do NOT miss any eligibility criteria, expenses, or program details from ANY chunk\n' +
                '4. Ensure the grant card covers the COMPLETE document, not just this final chunk\n\n' +
                'Generate the complete grant card now using ALL ' + totalChunks + ' chunks of information.';
            } else {
                promptText = 'CHUNK ' + chunkNumber + ' OF ' + totalChunks + ':\n' +
                '='.repeat(50) + '\n' +
                content + '\n' +
                '='.repeat(50) + '\n\n' +
                'Please confirm you have received and stored chunk ' + chunkNumber + ' of ' + totalChunks + '. Continue to remember ALL previous chunks. I will send chunk ' + (chunkNumber + 1) + ' next.';
            }
            
            const chunkHeader = document.createElement('div');
            chunkHeader.className = 'chunk-header';
            
            const titleSpan = document.createElement('span');
            titleSpan.textContent = title + ' (' + content.length.toLocaleString() + ' characters)';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy for CustomGPT.ai';
            copyBtn.onclick = function() { 
                copyToClipboard(copyBtn, promptText); 
            };
            
            chunkHeader.appendChild(titleSpan);
            chunkHeader.appendChild(copyBtn);
            
            const chunkContent = document.createElement('div');
            chunkContent.className = 'chunk-content';
            chunkContent.textContent = promptText;
            
            chunkDiv.appendChild(chunkHeader);
            chunkDiv.appendChild(chunkContent);
            
            chunksDiv.appendChild(chunkDiv);
        }
        
        async function copyToClipboard(button, text) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.style.background = '#28a745';
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.style.background = '#28a745';
                }, 2000);
            } catch (error) {
                console.error('Failed to copy text:', error);
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                button.textContent = 'Copied!';
                setTimeout(function() {
                    button.textContent = 'Copy for CustomGPT.ai';
                }, 2000);
            }
        }
    </script>
</body>
</html>
